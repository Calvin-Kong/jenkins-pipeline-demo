pipeline {
    agent any

    environment {
        DIRECTORY_PATH = '"C:\Users\calvi\Desktop\Deakin\SIT753\Credit task\jenkins-pipeline-demo\jenkinsfile"'
        TESTING_ENVIRONMENT = 'Testing-Env'
        PRODUCTION_ENVIRONMENT = 'Calvin Kong'  
    }

    stages {
        stage('Build') {
            steps {
                sh 'mvn clean install'
            }
        }

        stage('Unit and Integration Tests') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Code Analysis') {
            steps {
                sh 'sonar-scanner -Dsonar.projectKey=demo -Dsonar.host.url=http://localhost:8000 -Dsonar.login=<your_token>'
            }
        }

        stage('Security Scan') {
            steps {
                sh 'dependency-check.sh --project Demo --scan .'
            }
        }

        stage('Deploy to Staging') {
            steps {
                sh 'scp target/demo.jar user@staging-ip:/opt/app/'
                sh 'ssh user@staging-ip "java -jar /opt/app/demo.jar &"'
            }
        }

        stage('Integration Tests on Staging') {
            steps {
                sh 'newman run postman_collection.json'
            }
        }

        stage('Deploy to Production') {
            steps {
                sh 'scp target/demo.jar user@prod-ip:/opt/app/'
                sh 'ssh user@prod-ip "java -jar /opt/app/demo.jar &"'
            }
        }
    }
}